<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cognitive Analyst Test | Final Version</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0d1117; color: #e6edf3; }
        .gradient-text { background: linear-gradient(to right, #2dd4bf, #3b82f6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .card { 
            background-color: rgba(22, 27, 34, 0.8); 
            backdrop-filter: blur(12px); 
            border: 1px solid rgba(255, 255, 255, 0.1);
            /* NEW: Smooth transition for fade effect */
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
            opacity: 1;
        }
        /* NEW: Class for hiding screens with fade effect */
        .fade-out { opacity: 0; transform: translateY(10px); pointer-events: none; }
        .hidden { display: none; }

        .btn-primary { background: linear-gradient(to right, #14b8a6, #2563eb); transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(20, 184, 166, 0.2); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(20, 184, 166, 0.3); }
        .option-btn { background-color: #21262d; border: 1px solid #30363d; transition: all 0.2s; text-align: left; padding: 1rem; border-radius: 0.5rem; }
        .option-btn:hover { background-color: #30363d; border-color: #4b5563; transform: translateY(-1px); }
        
        /* NEW: Style for the selected answer */
        .option-btn.selected {
            background-color: rgba(20, 184, 166, 0.2);
            border-color: #14b8a6;
            animation: glow 0.5s ease-out;
        }
        @keyframes glow {
            from { box-shadow: 0 0 0px #14b8a6; }
            to { box-shadow: 0 0 10px #14b8a6; }
        }

        .scenario-box { background-color: #0d1117; border-left: 4px solid #14b8a6; padding: 1.25rem; border-radius: 0.5rem; }
        .form-input, .form-select { background-color: #161b22; border: 1px solid #30363d; color: #e6edf3; border-radius: 0.5rem; padding: 0.75rem 1rem; transition: border-color 0.3s, box-shadow 0.3s; -webkit-appearance: none; -moz-appearance: none; appearance: none; }
        .form-input:focus, .form-select:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3); }
        
        /* Custom Slider */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]:focus { outline: none; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 8px; cursor: pointer; background: #30363d; border-radius: 5px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: #14b8a6; cursor: pointer; margin-top: -6px; }
        
        /* Custom Toggle */
        .toggle-bg:after { content: ''; position: absolute; top: 2px; left: 2px; background: white; border-radius: 9999px; height: 1.25rem; width: 1.25rem; transition: transform 0.3s; }
        input:checked + .toggle-bg:after { transform: translateX(100%); }
        input:checked + .toggle-bg { background-color: #14b8a6; }
        
        .progress-glow { box-shadow: 0 0 10px rgba(20, 184, 166, 0.5); }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-3xl mx-auto">

        <!-- Welcome Screen -->
        <div id="welcome-screen" class="text-center card rounded-2xl p-8 md:p-12">
            <h1 class="text-4xl md:text-5xl font-extrabold mb-4">The <span class="gradient-text">Cognitive Analyst</span> Test</h1>
            <p class="text-gray-400 mb-8 text-lg">Discover your cognitive framework through scenario-based analysis. This improved version ensures balanced testing of all 8 cognitive functions for accurate results.</p>
            
            <div class="space-y-6 text-left max-w-sm mx-auto mb-10">
                <div>
                    <div class="flex justify-between items-center mb-1">
                        <label for="test-length-slider" class="font-semibold text-lg">Test Length:</label>
                        <span id="test-length-label" class="font-bold text-white text-lg">24 Questions</span>
                    </div>
                    <p class="text-sm text-gray-500 mb-2">Estimated time: <span id="estimated-time">~14 min</span></p>
                    <input type="range" id="test-length-slider" min="16" max="32" step="8" value="24" class="w-full" aria-label="Select test length">
                    <p class="text-xs text-gray-600 mt-2">Each length ensures perfect balance across all cognitive functions.</p>
                </div>
                
                <div class="flex items-center justify-between">
                    <label class="font-semibold text-lg">Expert Mode:</label>
                    <div class="flex items-center space-x-3">
                        <span id="toggle-label-off" class="text-gray-500">Show Functions</span>
                        <label for="hide-functions-toggle" class="flex items-center cursor-pointer">
                            <input type="checkbox" id="hide-functions-toggle" class="sr-only" checked>
                            <div class="toggle-bg relative w-10 h-6 bg-gray-600 rounded-full" aria-hidden="true"></div>
                        </label>
                        <span id="toggle-label-on" class="font-bold text-white opacity-50">Hide Functions</span>
                    </div>
                </div>
            </div>
            <button id="start-btn" class="btn-primary text-white font-bold py-3 px-8 rounded-full text-xl">Begin Analysis</button>
             <button id="resume-btn" class="hidden mt-4 bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-full transition-colors">Resume Previous Test</button>
        </div>

        <!-- Question Screen -->
        <div id="question-screen" class="hidden card rounded-2xl p-8 md:p-12">
            <div class="mb-6">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm text-gray-500">Progress</span>
                    <span id="question-counter" class="text-sm text-gray-500">1 of 24</span>
                </div>
                <div id="progress-bar" class="w-full bg-gray-700 rounded-full h-2.5">
                    <div id="progress" class="bg-gradient-to-r from-teal-500 to-blue-500 h-2.5 rounded-full progress-glow transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>
            
            <div class="mb-6">
                <h3 class="font-semibold text-gray-500 text-sm uppercase tracking-wider mb-2">Scenario</h3>
                <p id="scenario-text" class="scenario-box text-lg leading-relaxed"></p>
            </div>
            
            <h2 class="text-xl font-bold mb-4">Which approach resonates more with you?</h2>
            <div id="options-container" class="grid grid-cols-1 gap-4"></div>
        </div>

        <!-- Character Input Screen -->
        <div id="character-input-screen" class="hidden card rounded-2xl p-8 md:p-12">
            <h2 class="text-3xl font-bold text-center mb-2">Final Step: Personal Context</h2>
            <p class="text-gray-400 text-center mb-8">These details help create a more personalized analysis in your detailed report.</p>
            
            <div class="space-y-6">
                <div>
                    <label for="fav-char" class="block text-md font-semibold mb-2 text-gray-300">Favorite fictional character (optional):</label>
                    <input type="text" id="fav-char" class="form-input w-full" placeholder="e.g., Hermione Granger, Iron Man, etc.">
                </div>
                <div>
                    <label for="rel-char" class="block text-md font-semibold mb-2 text-gray-300">Most relatable character (optional):</label>
                    <input type="text" id="rel-char" class="form-input w-full" placeholder="e.g., Peter Parker, Elizabeth Bennet, etc.">
                </div>
            </div>
            
            <button id="get-results-btn" class="btn-primary text-white font-bold py-3 px-8 rounded-full text-xl w-full mt-8">See My Cognitive Profile</button>
        </div>

        <!-- Result Screen -->
        <div id="result-screen" class="hidden card rounded-2xl p-8 md:p-12">
            <div class="text-center mb-8">
                <h2 class="text-2xl font-bold text-gray-400 mb-2">Your Cognitive Profile:</h2>
                <p id="mbti-type" class="text-6xl md:text-7xl font-extrabold gradient-text mb-4"></p>
                <p id="mbti-title" class="text-2xl font-bold text-white mb-4"></p>
                
                <div class="bg-gray-900/50 rounded-lg p-4 mb-6 max-w-xs mx-auto">
                    <p class="text-sm text-gray-500 mb-1">Result Confidence</p>
                    <div class="flex items-center justify-center space-x-2">
                        <div class="w-32 bg-gray-700 rounded-full h-2">
                            <div id="confidence-bar" class="bg-gradient-to-r from-teal-500 to-blue-500 h-2 rounded-full"></div>
                        </div>
                        <span id="confidence-text" class="text-sm font-bold text-white"></span>
                    </div>
                </div>
            </div>
            
            <div class="mb-8">
                <h3 class="text-xl font-bold text-center mb-4">Your Cognitive Function Alignment</h3>
                <canvas id="resultChart" class="bg-gray-900/30 rounded-lg p-4"></canvas>
            </div>
            
            <div class="bg-gray-900/50 rounded-lg p-6 mb-8">
                <h3 class="text-lg font-bold text-white mb-4 text-center">Your Cognitive Function Scores</h3>
                <div id="function-scores" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
            </div>

            <div class="bg-gradient-to-br from-teal-900/30 to-blue-900/30 border border-teal-500/30 p-6 rounded-lg mb-6 text-center">
                <h3 class="text-xl font-bold text-white mb-3">📊 Get Your Comprehensive Report</h3>
                <p class="text-gray-300 mb-4">Receive an in-depth 15-page analysis including career paths, relationship insights, growth strategies, and more.</p>
                <p class="text-3xl font-extrabold text-white mb-4">$12 USD</p>
                <a id="get-detailed-report-btn" href="#" target="_blank" rel="noopener noreferrer" class="btn-primary inline-block text-white font-bold py-3 px-8 rounded-full text-lg w-full max-w-xs mx-auto">
                    Get Detailed Analysis
                </a>
                <p class="text-xs text-gray-600 mt-3">Secure Google Form • Payment via PayPal/Stripe • Delivered within 24 hours</p>
            </div>
            
            <div class="flex space-x-3">
                <button id="restart-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-full flex-1 transition-colors">Take Again</button>
                <button id="share-btn" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-6 rounded-full flex-1 transition-colors">Share Results</button>
            </div>
        </div>
    </div>

    <!-- NEW: Toast notification for sharing -->
    <div id="toast" class="fixed bottom-10 right-10 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg transition-opacity duration-300 opacity-0">
        Results copied to clipboard!
    </div>


    <script>
    // NEW: Wrapped all logic in an object to avoid polluting global scope
    const mbtiTestApp = {
        // --- DATA & CONFIG ---
        mbtiInfo: {
            ISTJ: { title: "The Inspector", stack: ['Si', 'Te', 'Fi', 'Ne'] }, ISFJ: { title: "The Protector", stack: ['Si', 'Fe', 'Ti', 'Ne'] },
            INFJ: { title: "The Advocate", stack: ['Ni', 'Fe', 'Ti', 'Se'] }, INTJ: { title: "The Architect", stack: ['Ni', 'Te', 'Fi', 'Se'] },
            ISTP: { title: "The Virtuoso", stack: ['Ti', 'Se', 'Ni', 'Fe'] }, ISFP: { title: "The Adventurer", stack: ['Fi', 'Se', 'Ni', 'Te'] },
            INFP: { title: "The Mediator", stack: ['Fi', 'Ne', 'Si', 'Te'] }, INTP: { title: "The Logician", stack: ['Ti', 'Ne', 'Si', 'Fe'] },
            ESTP: { title: "The Entrepreneur", stack: ['Se', 'Ti', 'Fe', 'Ni'] }, ESFP: { title: "The Entertainer", stack: ['Se', 'Fi', 'Te', 'Ni'] },
            ENFP: { title: "The Campaigner", stack: ['Ne', 'Fi', 'Te', 'Si'] }, ENTP: { title: "The Debater", stack: ['Ne', 'Ti', 'Fe', 'Si'] },
            ESTJ: { title: "The Executive", stack: ['Te', 'Si', 'Ne', 'Fi'] }, ESFJ: { title: "The Consul", stack: ['Fe', 'Si', 'Ne', 'Ti'] },
            ENFJ: { title: "The Protagonist", stack: ['Fe', 'Ni', 'Se', 'Ti'] }, ENTJ: { title: "The Commander", stack: ['Te', 'Ni', 'Se', 'Fi'] }
        },
        questionBank: {
             TeFi: [
                { scenario: "Your company asks you to work on a project that would be profitable but conflicts with your personal values.", options: [ { text: "Decline the project - staying true to your values is more important than external success.", cleanText: "Decline the project - staying true to your values is more important than external success.", value: "Fi" }, { text: "Take the project because it is the objectively effective and profitable course of action for the company.", cleanText: "Take the project because it is the objectively effective and profitable course of action for the company.", value: "Te" } ] },
                { scenario: "When evaluating a new policy, what is your primary concern?", options: [ { text: "Does this policy align with what I personally believe is right and authentic?", cleanText: "Does this policy align with what I personally believe is right and authentic?", value: "Fi" }, { text: "Is this policy efficient, logical, and does it produce measurable results?", cleanText: "Is this policy efficient, logical, and does it produce measurable results?", value: "Te" } ] },
                { scenario: "A brilliant leader seeks to create a 'perfect' new world order based on their own definition of justice. They view their own personal feelings and sentimental attachments as weaknesses that must be suppressed to avoid making mistakes.", options: [ { text: "This leader is driven by a primary need to impose an objective, logical system on the world, guided by a singular vision. Personal values are actively suppressed as a liability.", cleanText: "This leader is driven by a primary need to impose an objective, logical system on the world, guided by a singular vision. Personal values are actively suppressed as a liability.", value: "Te" }, { text: "This leader is driven by a quiet but strong personal moral code. The systems they build are merely tools to realize this personal vision, not the primary goal itself.", cleanText: "This leader is driven by a quiet but strong personal moral code. The systems they build are merely tools to realize this personal vision, not the primary goal itself.", value: "Fi" } ] },
                { scenario: "A young activist is driven by a powerful, personal conviction that a certain law is unjust. They can't always articulate their reasoning with complex logic, but they are absolutely unwavering because the law violates their core identity and what they feel is right.", options: [ { text: "Their motivation comes from a deep, non-negotiable internal value system. The authenticity of their feeling is more important than external logic or group consensus.", cleanText: "Their motivation comes from a deep, non-negotiable internal value system. The authenticity of their feeling is more important than external logic or group consensus.", value: "Fi" }, { text: "Their motivation comes from an objective analysis of the law's negative impact on society's efficiency and structure, and they are driven to correct this systemic flaw.", cleanText: "Their motivation comes from an objective analysis of the law's negative impact on society's efficiency and structure, and they are driven to correct this systemic flaw.", value: "Te" } ] },
                { scenario: "When faced with a difficult choice, a leader's first question is 'What is the most effective path to our goal?' They prioritize objective outcomes and measurable success.", options: [ { text: "This is a clear focus on external effectiveness. The decision-making process is detached, analytical, and focused on impersonal criteria like efficiency.", cleanText: "The decision-making process is detached, analytical, and focused on impersonal criteria like efficiency.", value: "Te" }, { text: "This is a focus on personal values. The 'goal' itself is a reflection of what they believe is right, and effectiveness is just the means to that value-driven end.", cleanText: "The 'goal' itself is a reflection of what they believe is right, and effectiveness is just the means to that value-driven end.", value: "Fi" } ] },
            ],
            FeTi: [
                { scenario: "In a team meeting, someone presents a solution that everyone agrees with, but you notice a logical flaw in the reasoning.", options: [ { text: "Point out the flaw immediately - logical consistency is more important than group harmony.", cleanText: "Point out the flaw immediately - logical consistency is more important than group harmony.", value: "Ti" }, { text: "Support the group decision since everyone else agrees and it maintains team cohesion.", cleanText: "Support the group decision since everyone else agrees and it maintains team cohesion.", value: "Fe" } ] },
                { scenario: "When giving feedback to someone who's sensitive to criticism, your primary focus is on:", options: [ { text: "Framing the feedback in a way that maintains their confidence and motivation.", cleanText: "Framing the feedback in a way that maintains their confidence and motivation.", value: "Fe" }, { text: "Delivering the most accurate and logically sound critique, even if it's uncomfortable.", cleanText: "Delivering the most accurate and logically sound critique, even if it's uncomfortable.", value: "Ti" } ] },
                { scenario: "A character consistently makes decisions that are illogical and even self-destructive, purely to please a partner or fit in with a group. They justify their poor choices with weak, emotional reasoning.", options: [ { text: "Their primary drive is to maintain external harmony and be loved, even if it means ignoring their own internal logic. Their routines support this social goal.", cleanText: "Their primary drive is to maintain external harmony and be loved, even if it means ignoring their own internal logic. Their routines support this social goal.", value: "Fe" }, { text: "Their actions are driven by a flawed but consistent internal logic. They believe these self-destructive actions are the 'correct' steps within their own framework, regardless of social outcomes.", cleanText: "Their actions are driven by a flawed but consistent internal logic. They believe these self-destructive actions are the 'correct' steps within their own framework, regardless of social outcomes.", value: "Ti" } ] },
                { scenario: "You need to understand a complex system. What is your preferred method?", options: [ { text: "Discuss it with a group of people, building on their ideas and creating a shared understanding.", cleanText: "Discuss it with a group of people, building on their ideas and creating a shared understanding.", value: "Fe" }, { text: "Take it apart by yourself, piece by piece, until you have built a complete and logically consistent model in your own mind.", cleanText: "Take it apart by yourself, piece by piece, until you have built a complete and logically consistent model in your own mind.", value: "Ti" } ] },
                { scenario: "When you see a social injustice, what is your first impulse?", options: [ { text: "To understand the flawed logical principles that allowed the injustice to happen in the first place.", cleanText: "To understand the flawed logical principles that allowed the injustice to happen in the first place.", value: "Ti" }, { text: "To address the suffering of the people affected and restore a sense of community and fairness.", cleanText: "To address the suffering of the people affected and restore a sense of community and fairness.", value: "Fe" } ] },
            ],
            NeSi: [
                { scenario: "When starting a new project, you are more likely to:", options: [ { text: "Brainstorm many new possibilities and innovative approaches, even if they are untested.", cleanText: "Brainstorm many new possibilities and innovative approaches, even if they are untested.", value: "Ne" }, { text: "Rely on established, proven methods that you know from past experience will be reliable.", cleanText: "Rely on established, proven methods that you know from past experience will be reliable.", value: "Si" } ] },
                { scenario: "You're planning a vacation. What is more appealing?", options: [ { text: "Going to a brand new place to explore unexpected opportunities and possibilities.", cleanText: "Going to a brand new place to explore unexpected opportunities and possibilities.", value: "Ne" }, { text: "Returning to a beloved location where you have fond memories and know you'll have a comfortable, reliable experience.", cleanText: "Returning to a beloved location where you have fond memories and know you'll have a comfortable, reliable experience.", value: "Si" } ] },
                { scenario: "When listening to someone tell a story, you are more focused on:", options: [ { text: "The specific, concrete details and the sequence of events as they actually happened.", cleanText: "The specific, concrete details and the sequence of events as they actually happened.", value: "Si" }, { text: "The underlying themes, connections to other ideas, and the future implications of the story.", cleanText: "The underlying themes, connections to other ideas, and the future implications of the story.", value: "Ne" } ] },
                { scenario: "When approaching a familiar task, you prefer to:", options: [ { text: "Follow the established, step-by-step procedure that you know works well.", cleanText: "Follow the established, step-by-step procedure that you know works well.", value: "Si" }, { text: "Experiment with new ways of doing it to see if you can find a novel or more interesting approach.", cleanText: "Experiment with new ways of doing it to see if you can find a novel or more interesting approach.", value: "Ne" } ] },
                { scenario: "An inventor's workshop is filled with dozens of half-finished projects, as they constantly jump from one new, exciting idea to the next without always seeing them through.", options: [ { text: "The joy is in the exploration of new possibilities and the initial act of creation, not necessarily in the tedious process of finishing every single one.", cleanText: "The joy is in the exploration of new possibilities and the initial act of creation, not necessarily in the tedious process of finishing every single one.", value: "Ne" }, { text: "The primary focus is on the detailed, hands-on process of building. They move on when the initial, familiar steps of construction are complete.", cleanText: "The primary focus is on the detailed, hands-on process of building. They move on when the initial, familiar steps of construction are complete.", value: "Si" } ] },
            ],
            NiSe: [
                { scenario: "A general on the battlefield makes a risky, split-second decision based on a gut feeling about the enemy's movement, ignoring the established plan.", options: [ { text: "They are reacting to the immediate, tangible reality of the battlefield and seizing a momentary opportunity that a plan couldn't account for.", cleanText: "They are reacting to the immediate, tangible reality of the battlefield and seizing a momentary opportunity that a plan couldn't account for.", value: "Se" }, { text: "They perceived an underlying pattern in the chaos that pointed to a future outcome, and they acted on that abstract prediction.", cleanText: "They perceived an underlying pattern in the chaos that pointed to a future outcome, and they acted on that abstract prediction.", value: "Ni" } ] },
                { scenario: "An adventurer suddenly decides to sell all their possessions and move to a new country, not with a plan, but simply to experience a new way of life and see what happens.", options: [ { text: "They are seeking novel sensory experiences in the present moment and are highly adaptable to their physical environment, prioritizing action over planning.", cleanText: "They are seeking novel sensory experiences in the present moment and are highly adaptable to their physical environment, prioritizing action over planning.", value: "Se" }, { text: "They have an inner vision of a more exciting life and are making a decisive move to achieve that structured goal, even if it looks spontaneous.", cleanText: "They have an inner vision of a more exciting life and are making a decisive move to achieve that structured goal, even if it looks spontaneous.", value: "Ni" } ] },
                { scenario: "A stoic soldier is known for his incredible, almost supernatural, speed and reactivity in combat. He makes split-second decisions based on the immediate physical environment, not a grand strategy.", options: [ { text: "His combat prowess comes from a mastery of the physical world and reacting to the present moment. He is not following a grand plan.", cleanText: "His combat prowess comes from a mastery of the physical world and reacting to the present moment. He is not following a grand plan.", value: "Se" }, { text: "His combat skill is the result of a long-term, perfected vision of battle. His actions are the result of a pre-determined internal structure, not just reaction.", cleanText: "His combat skill is the result of a long-term, perfected vision of battle. His actions are the result of a pre-determined internal structure, not just reaction.", value: "Ni" } ] },
                { scenario: "When approaching a complex problem, what is your preferred first step?", options: [ { text: "To step back and try to grasp the entire system at once, looking for a single, underlying pattern or future implication.", cleanText: "To step back and try to grasp the entire system at once, looking for a single, underlying pattern or future implication.", value: "Ni" }, { text: "To engage with the problem directly and hands-on, gathering real-time data and reacting to what is immediately in front of you.", cleanText: "To engage with the problem directly and hands-on, gathering real-time data and reacting to what is immediately in front of you.", value: "Se" } ] },
                { scenario: "A skilled craftsman is completely absorbed in their work, paying meticulous attention to the texture of the wood, the feel of the tools, and the physical quality of their creation. They are grounded in the here-and-now of their craft.", options: [ { text: "Their focus is entirely on the tangible, sensory details of the present moment. They are a master of the concrete world.", cleanText: "Their focus is entirely on the tangible, sensory details of the present moment. They are a master of the concrete world.", value: "Se" }, { text: "Their craft is a way of bringing an abstract, internal vision into reality. The physical details are just the medium for their conceptual idea.", cleanText: "Their craft is a way of bringing an abstract, internal vision into reality. The physical details are just the medium for their conceptual idea.", value: "Ni" } ] },
            ]
        },

        // --- STATE MANAGEMENT ---
        state: {
            currentQuestionIndex: 0,
            scores: {},
            questionsForTest: [],
            hideFunctions: true,
            userResponses: {}
        },
        resultChart: null,

        // --- DOM ELEMENTS CACHE ---
        dom: {},

        // --- INITIALIZATION ---
        init() {
            this.cacheDom();
            this.addEventListeners();
            this.updateSliderLabel();
            this.updateToggleLabels();
            this.checkForSavedState();
        },

        cacheDom() {
            this.dom.welcomeScreen = document.getElementById('welcome-screen');
            this.dom.questionScreen = document.getElementById('question-screen');
            this.dom.characterInputScreen = document.getElementById('character-input-screen');
            this.dom.resultScreen = document.getElementById('result-screen');
            this.dom.startBtn = document.getElementById('start-btn');
            this.dom.resumeBtn = document.getElementById('resume-btn');
            this.dom.testLengthSlider = document.getElementById('test-length-slider');
            this.dom.testLengthLabel = document.getElementById('test-length-label');
            this.dom.estimatedTime = document.getElementById('estimated-time');
            this.dom.hideFunctionsToggle = document.getElementById('hide-functions-toggle');
            this.dom.toggleLabelOff = document.getElementById('toggle-label-off');
            this.dom.toggleLabelOn = document.getElementById('toggle-label-on');
            this.dom.getResultsBtn = document.getElementById('get-results-btn');
            this.dom.restartBtn = document.getElementById('restart-btn');
            this.dom.shareBtn = document.getElementById('share-btn');
            this.dom.scenarioText = document.getElementById('scenario-text');
            this.dom.optionsContainer = document.getElementById('options-container');
            this.dom.progress = document.getElementById('progress');
            this.dom.questionCounter = document.getElementById('question-counter');
            this.dom.resultChartCanvas = document.getElementById('resultChart');
            this.dom.toast = document.getElementById('toast');
        },

        addEventListeners() {
            this.dom.testLengthSlider.addEventListener('input', () => this.updateSliderLabel());
            this.dom.hideFunctionsToggle.addEventListener('change', () => this.updateToggleLabels());
            this.dom.startBtn.addEventListener('click', () => this.startTest());
            this.dom.resumeBtn.addEventListener('click', () => this.resumeTest());
            this.dom.getResultsBtn.addEventListener('click', () => this.calculateAndShowResult());
            this.dom.restartBtn.addEventListener('click', () => this.restartTest());
            this.dom.shareBtn.addEventListener('click', () => this.shareResults());
        },
        
        // --- NEW: STATE PERSISTENCE ---
        saveState() {
            localStorage.setItem('mbtiTestState', JSON.stringify(this.state));
        },

        loadState() {
            const savedState = localStorage.getItem('mbtiTestState');
            if (savedState) {
                this.state = JSON.parse(savedState);
                return true;
            }
            return false;
        },

        checkForSavedState() {
            if (localStorage.getItem('mbtiTestState')) {
                this.dom.resumeBtn.classList.remove('hidden');
            }
        },
        
        clearState() {
            localStorage.removeItem('mbtiTestState');
            this.dom.resumeBtn.classList.add('hidden');
        },

        // --- UI & DISPLAY LOGIC ---
        updateSliderLabel() {
            const numQuestions = this.dom.testLengthSlider.value;
            this.dom.testLengthLabel.textContent = `${numQuestions} Questions`;
            const minutes = Math.round((numQuestions * 35) / 60);
            this.dom.estimatedTime.textContent = `~${minutes} min`;
        },

        updateToggleLabels() {
            const isChecked = this.dom.hideFunctionsToggle.checked;
            this.state.hideFunctions = isChecked;
            this.dom.toggleLabelOn.classList.toggle('opacity-50', !isChecked);
            this.dom.toggleLabelOff.classList.toggle('opacity-50', isChecked);
        },

        // NEW: Smooth screen transitions
        transitionTo(screenElement) {
            const screens = [this.dom.welcomeScreen, this.dom.questionScreen, this.dom.characterInputScreen, this.dom.resultScreen];
            screens.forEach(screen => {
                if (screen !== screenElement) {
                    screen.classList.add('fade-out');
                    // Use a timeout to set display:none after fade out
                    setTimeout(() => screen.classList.add('hidden'), 500);
                }
            });
            
            screenElement.classList.remove('hidden');
            // Use a timeout to trigger the fade-in animation
            setTimeout(() => screenElement.classList.remove('fade-out'), 10);
        },

        displayQuestion() {
            if (this.state.currentQuestionIndex < this.state.questionsForTest.length) {
                const question = this.state.questionsForTest[this.state.currentQuestionIndex];
                this.dom.questionCounter.textContent = `${this.state.currentQuestionIndex + 1} of ${this.state.questionsForTest.length}`;
                this.dom.scenarioText.textContent = question.scenario;
                this.dom.optionsContainer.innerHTML = '';
                
                question.options.forEach(option => {
                    const button = document.createElement('button');
                    button.innerHTML = this.state.hideFunctions 
                        ? option.cleanText 
                        : `<span class="font-bold text-teal-400">${option.value}:</span> ${option.text}`;
                    
                    button.classList.add('option-btn', 'text-white', 'font-semibold');
                    button.onclick = (e) => this.selectAnswer(option.value, e.currentTarget);
                    this.dom.optionsContainer.appendChild(button);
                });

                const progressPercentage = ((this.state.currentQuestionIndex) / this.state.questionsForTest.length) * 100;
                this.dom.progress.style.width = `${progressPercentage}%`;
                this.saveState();
            } else {
                this.transitionTo(this.dom.characterInputScreen);
            }
        },

        // --- CORE TEST LOGIC ---
        startTest(isResuming = false) {
            if (!isResuming) {
                const testLength = parseInt(this.dom.testLengthSlider.value);
                const questionsPerCategory = testLength / 4;
                let selectedQuestions = [];
                for (const category in this.questionBank) {
                    const shuffled = this.questionBank[category].sort(() => 0.5 - Math.random());
                    selectedQuestions.push(...shuffled.slice(0, questionsPerCategory));
                }
                
                this.state.questionsForTest = selectedQuestions.sort(() => 0.5 - Math.random());
                this.state.currentQuestionIndex = 0;
                this.state.scores = { Te: 0, Ti: 0, Fe: 0, Fi: 0, Ne: 0, Ni: 0, Se: 0, Si: 0 };
                this.state.userResponses = {};
            }
            
            this.transitionTo(this.dom.questionScreen);
            this.displayQuestion();
        },

        resumeTest() {
            if (this.loadState()) {
                this.startTest(true);
            }
        },
        
        restartTest() {
            this.clearState();
            this.transitionTo(this.dom.welcomeScreen);
        },

        selectAnswer(value, buttonElement) {
            // NEW: Visual feedback on selection
            buttonElement.classList.add('selected');
            
            // Disable buttons to prevent multi-click
            Array.from(this.dom.optionsContainer.children).forEach(btn => btn.disabled = true);

            if (this.state.scores.hasOwnProperty(value)) {
                this.state.scores[value]++;
            }

            setTimeout(() => {
                this.state.currentQuestionIndex++;
                this.displayQuestion();
            }, 500); // Wait for feedback animation
        },

        calculateAndShowResult() {
            const favChar = document.getElementById('fav-char').value;
            const relChar = document.getElementById('rel-char').value;

            const preferredFunctions = {
                TeFi: this.state.scores.Te >= this.state.scores.Fi ? 'Te' : 'Fi',
                FeTi: this.state.scores.Fe >= this.state.scores.Ti ? 'Fe' : 'Ti',
                NeSi: this.state.scores.Ne >= this.state.scores.Si ? 'Ne' : 'Si',
                NiSe: this.state.scores.Ni >= this.state.scores.Se ? 'Ni' : 'Se'
            };

            const functionToPair = { 'Te': 'TeFi', 'Fi': 'TeFi', 'Fe': 'FeTi', 'Ti': 'FeTi', 'Ne': 'NeSi', 'Si': 'NeSi', 'Ni': 'NiSe', 'Se': 'NiSe' };

            let rawTypeScores = Object.entries(this.mbtiInfo).map(([type, { stack }]) => {
                let score = 0;
                if (stack.includes(preferredFunctions.TeFi)) score += 4;
                if (stack.includes(preferredFunctions.FeTi)) score += 4;
                if (stack.includes(preferredFunctions.NeSi)) score += 4;
                if (stack.includes(preferredFunctions.NiSe)) score += 4;
                if (stack[0] === preferredFunctions[functionToPair[stack[0]]]) score += 2;
                if (stack[1] === preferredFunctions[functionToPair[stack[1]]]) score += 1;
                return { type, score };
            });
            
            const maxScore = Math.max(...rawTypeScores.map(item => item.score));
            const finalTypeScores = rawTypeScores.map(item => ({ type: item.type, score: (item.score / maxScore) * 100 })).sort((a, b) => b.score - a.score);

            const finalMbtiType = finalTypeScores[0].type;
            this.state.userResponses = {
                finalType: finalMbtiType,
                top5Types: finalTypeScores.slice(0, 5).map(item => `${item.type} (${item.score.toFixed(0)}%)`).join(', '),
                favChar,
                relChar,
                scores: JSON.stringify(this.state.scores)
            };

            this.transitionTo(this.dom.resultScreen);
            
            document.getElementById('mbti-type').textContent = finalMbtiType;
            document.getElementById('mbti-title').textContent = this.mbtiInfo[finalMbtiType].title;
            
            const confidence = finalTypeScores[0].score - (finalTypeScores[1]?.score || 0);
            const confidencePercentage = Math.min(100, Math.max(10, confidence * 4));
            document.getElementById('confidence-bar').style.width = `${confidencePercentage}%`;
            document.getElementById('confidence-text').textContent = confidencePercentage > 75 ? 'Very High' : confidencePercentage > 50 ? 'High' : 'Moderate';

            this.displayResultChart(finalTypeScores.slice(0, 5));
            this.displayFunctionScores(this.state.scores);
            this.updateGoogleFormLink();
            this.clearState();
        },

        // --- RESULTS DISPLAY & SHARING ---
        displayResultChart(topTypes) {
            if (this.resultChart) this.resultChart.destroy();
            const ctx = this.dom.resultChartCanvas.getContext('2d');
            this.resultChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: topTypes.map(item => item.type),
                    datasets: [{
                        label: 'Alignment Score',
                        data: topTypes.map(item => item.score),
                        backgroundColor: ['rgba(45, 212, 191, 0.8)', 'rgba(59, 130, 246, 0.6)', 'rgba(59, 130, 246, 0.5)', 'rgba(59, 130, 246, 0.4)', 'rgba(59, 130, 246, 0.3)'],
                        borderColor: ['#2dd4bf', '#3b82f6', '#3b82f6', '#3b82f6', '#3b82f6'],
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    scales: {
                        x: { beginAtZero: true, max: 100, ticks: { color: '#8b949e' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } },
                        y: { ticks: { color: '#e6edf3', font: { size: 14, weight: 'bold' } }, grid: { display: false } }
                    },
                    plugins: { legend: { display: false }, tooltip: { callbacks: { label: (context) => ` Alignment: ${context.raw.toFixed(0)}%` } } }
                }
            });
        },

        displayFunctionScores(scores) {
            const container = document.getElementById('function-scores');
            container.innerHTML = '';
            const functionOrder = ['Te', 'Ti', 'Fe', 'Fi', 'Ne', 'Ni', 'Se', 'Si'];
            const functionColors = { Te: 'text-red-400', Ti: 'text-red-300', Fe: 'text-teal-400', Fi: 'text-teal-300', Ne: 'text-sky-400', Ni: 'text-sky-300', Se: 'text-amber-400', Si: 'text-amber-300' };
            functionOrder.forEach(func => {
                container.innerHTML += `
                    <div class="bg-gray-800 p-3 rounded-lg text-center">
                        <p class="font-bold text-lg ${functionColors[func]}">${func}</p>
                        <p class="text-2xl font-bold">${scores[func]}</p>
                    </div>`;
            });
        },
        
        updateGoogleFormLink() {
            // IMPORTANT: Replace these with your actual Form ID and Entry IDs
            const formURL = "https://docs.google.com/forms/d/e/YOUR_FORM_ID_HERE/viewform";
            const entryMap = {
                finalType: "entry.XXXXXXXXXX", top5Types: "entry.XXXXXXXXXX",
                favChar: "entry.XXXXXXXXXX", relChar: "entry.XXXXXXXXXX",
                scores: "entry.XXXXXXXXXX"
            };
            const params = new URLSearchParams();
            for (const key in this.state.userResponses) {
                if (entryMap[key]) params.append(entryMap[key], this.state.userResponses[key]);
            }
            document.getElementById('get-detailed-report-btn').href = `${formURL}?${params.toString()}`;
        },
        
        shareResults() {
            const resultText = `I took the Cognitive Analyst Test and my type is ${this.state.userResponses.finalType}! My top alignments are: ${this.state.userResponses.top5Types}. Find out your type here: ${window.location.href}`;
            navigator.clipboard.writeText(resultText).then(() => {
                this.dom.toast.classList.remove('opacity-0');
                setTimeout(() => {
                    this.dom.toast.classList.add('opacity-0');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy text: ', err);
            });
        }
    };

    // Initialize the app when the DOM is ready
    document.addEventListener('DOMContentLoaded', () => mbtiTestApp.init());
    </script>
</body>
</html>
